<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Status Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
</head>
<body>
    <h1>Status Dashboard</h1>
    <div class="dashboard">
        <div class="entry"><span class="label">Serial #:</span> <span class="serial"></span></div>
        <div class="entry"><span class="label">Time:</span> <span class="time"></span></div>
        <div class="entry"><span class="label">Schedule Status:</span> <span class="schedule_status"></span></div>
        <div class="entry"><span class="label">Flipped Status:</span> <span class="flipped_status"></span></div>

    </div>
    <br>
    <div class="status-row">
        <div class="status-container">
            <div class="entry"><span class="label">Schedule Status:<br>(1 Scheduled, -1 Unscheduled)</span> <span class="schedule_status"></span></div>
            <div class="chart-container">
                <canvas id="schedChart"></canvas>
            </div>
        </div>
        <div class="status-container">
            <div class="entry"><span class="label">Flipped Status:<br>(1 Flipped, -1 Not Flipped)</span> <span class="flipped_status"></span></div>
            <div class="chart-container">
                <canvas id="flippedChart"></canvas>
            </div>
        </div>
    </div>
    <script>
        // Initialize "sched" chart
        let schedLabelsGlobal = [];
        let schedValuesGlobal = [];
        let ctxSched = document.getElementById('schedChart').getContext('2d');
        let schedChart = new Chart(ctxSched, {
            type: 'line',
            data: {
                labels: schedLabelsGlobal,
                datasets: [{
                    label: 'Schedule Status',
                    data: schedValuesGlobal,
                    borderColor: 'blue',
                    fill: false
                }]
            },
            options: {
                scales: {
                    y: {
                        min: -1,
                        max: 1,
                        stepSize: 2,
                        callback: function(value) {
                            if (value === 1) return 'Scheduled';
                            if (value === -1) return 'Unscheduled';
                            return null;
                        }
                    }
                }
            }
        });

        // Initialize "flipped" chart
        let flippedLabelsGlobal = [];
        let flippedValuesGlobal = [];
        let ctxFlipped = document.getElementById('flippedChart').getContext('2d');
        let flippedChart = new Chart(ctxFlipped, {
            type: 'line',
            data: {
                labels: flippedLabelsGlobal,
                datasets: [{
                    label: 'Flipped Status',
                    data: flippedValuesGlobal,
                    borderColor: 'green',
                    fill: false
                }]
            },
            options: {
                scales: {
                    y: {
                        min: -1,
                        max: 1,
                        stepSize: 2,
                        callback: function(value) {
                            if (value === 1) return 'Flipped';
                            if (value === -1) return 'Unflipped';
                            return null;
                        }
                    }
                }
            }
        });

        function updateStatus() {
            fetch('/status_data')
                .then(response => response.json())
                .then(data => {

                    let est_time = data.data['time'];
                    let utc_time = data.data['utc_time'];
                    document.querySelector('.time').innerText = est_time + ' | ' + utc_time;
                    document.querySelector('.serial').innerText = data.data['serial'];
                    document.querySelector('.schedule_status').innerText = data.data['sched'] == 1 ? 'Scheduled' : 'Unscheduled';
                    document.querySelector('.flipped_status').innerText = data.data['flipped'] == 1 ? 'Flipped' : 'Unflipped';

                    // Update "sched" chart data
                    let newSchedLabels = data.schedule_history.map(event => event[0]);
                    let newSchedValues = data.schedule_history.map(event => event[1] === "Scheduled" ? 1 : -1);
                    if (newSchedLabels.length > schedLabelsGlobal.length) {
                        schedLabelsGlobal.push(...newSchedLabels.slice(schedLabelsGlobal.length));
                        schedValuesGlobal.push(...newSchedValues.slice(schedValuesGlobal.length));
                        schedChart.update();
                    }

                    // Update "flipped" chart data
                    let newFlippedLabels = data.flipped_history.map(event => event[0]);
                    let newFlippedValues = data.flipped_history.map(event => event[1] === "Flipped" ? 1 : -1);
                    if (newFlippedLabels.length > flippedLabelsGlobal.length) {
                        flippedLabelsGlobal.push(...newFlippedLabels.slice(flippedLabelsGlobal.length));
                        flippedValuesGlobal.push(...newFlippedValues.slice(flippedValuesGlobal.length));
                        flippedChart.update();
                    }
                });
        }

        // Update status every 4 seconds
        setInterval(updateStatus, 4000);
        updateStatus(); // Initial update
    </script>
</body>
</html>
